<html>
  <head>
    <title>Geoparser</title>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">

  </head>
  <body>
    <input style="position: absolute; left: 216px;width: 220px;font-size: 16px;height: 40px;" id="pac-input" class="controls" type="text" placeholder="Search Box"/>
    <div id="map"></div>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB41DRUbKWJHPxaFjMAwdrzWzbVKartNGg&callback=initMap&libraries=places,drawing&v=weekly" defer></script>
    <script src="https://code.jquery.com/jquery-3.2.1.js" integrity="sha256-DZAnKJ/6XZ9si04Hgrsxu/8s717jcIzLy3oi35EouyE=" crossorigin="anonymous"></script>

<script>
    let map
    let drawingManager
    let selectedShape
    let infowindow
    let shapeCollection = []
    let markers = []

    const clearSelection = () => {
        if (selectedShape) {
            selectedShape.setEditable(false)
            selectedShape = null
        }
    }

    const setSelection = shape =>  {
        let content = `<p style="margin-top: -17px;margin-bottom: 8px;"><br><small>Radius: ${Number(shape.getRadius() / 1000).toFixed(2)}km<br>Max r radius: ${100}m</small></p>`
        let lat = shape.getCenter().lat()
        let lng = shape.getCenter().lng()
        
        clearSelection()
        
        infowindow.setContent(`${content}<a hre='' style='text-decoration: none;' class='text-danger' onclick='deleteSelectedShape()' id='del" + shape.id + "'><svg style='width: 10px' class="svg-inline--fa fa-trash-alt fa-w-14" aria-hidden="true" data-prefix="fas" data-icon="trash-alt" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" data-fa-i2svg=""><path fill="currentColor" d="M0 84V56c0-13.3 10.7-24 24-24h112l9.4-18.7c4-8.2 12.3-13.3 21.4-13.3h114.3c9.1 0 17.4 5.1 21.5 13.3L312 32h112c13.3 0 24 10.7 24 24v28c0 6.6-5.4 12-12 12H12C5.4 96 0 90.6 0 84zm416 56v324c0 26.5-21.5 48-48 48H80c-26.5 0-48-21.5-48-48V140c0-6.6 5.4-12 12-12h360c6.6 0 12 5.4 12 12zm-272 68c0-8.8-7.2-16-16-16s-16 7.2-16 16v224c0 8.8 7.2 16 16 16s16-7.2 16-16V208zm96 0c0-8.8-7.2-16-16-16s-16 7.2-16 16v224c0 8.8 7.2 16 16 16s16-7.2 16-16V208zm96 0c0-8.8-7.2-16-16-16s-16 7.2-16 16v224c0 8.8 7.2 16 16 16s16-7.2 16-16V208z"></path></svg> Remove this shape</a>`)
        infowindow.setPosition({lat: lat, lng: lng})
        infowindow.open(map)
        
        selectedShape = shape
        shape.setEditable(true)
        
        if (shapeCollection.every(item => item.id != shape.id)) {
            shapeCollection.push(shape)
        }
        
        selectStyle()
    }

    const deleteSelectedShape =  () => {
        infowindow.close()

        for(let i = 0; i < shapeCollection.length; i++){ 
            shapeCollection[i].setMap(null)
        }

        shapeCollection = []
    }

    const selectStyle = () => {
        if (selectedShape) {
            selectedShape.set('fillColor', $('#f_color').val())
            selectedShape.set('fillOpacity', $("#opacity").val())
            selectedShape.set('strokeColor', $('#l_color').val())
            selectedShape.set('strokeOpacity', $("#line_opacity").val())
            selectedShape.set('strokeWeight', $("#stroke").val())
        }
    }

    function initMap () {
        // Main

        map = new google.maps.Map(document.getElementById("map"), { center: { lat: 50.40444089177163, lng: 30.62135376141017}, zoom: 8})
        infowindow = new google.maps.InfoWindow({size: new google.maps.Size(250, 100)})
    
        drawingManager = new google.maps.drawing.DrawingManager({
            drawingMode: google.maps.drawing.OverlayType.MARKER,
            drawingControl: true,
            drawingControlOptions: {
                position: google.maps.ControlPosition.TOP_CENTER,
                drawingModes: [
                    google.maps.drawing.OverlayType.CIRCLE
                ],
            },
            circleOptions: {
                fillColor: "#4c6fdf",
                fillOpacity: 0.5,
                strokeWeight: 2,
                clickable: true,
                editable: true,
                zIndex: 0,
            }
        })
    
        drawingManager.setMap(map)

        const input = document.getElementById("pac-input")
        const searchBox = new google.maps.places.SearchBox(input)
    
        map.controls[google.maps.ControlPosition.TOP_LEFT].push(input)

        map.addListener("bounds_changed", () => {
            searchBox.setBounds(map.getBounds())
        });

        searchBox.addListener("places_changed", () => {
            const places = searchBox.getPlaces()
        
            if (places.length == 0) {
                return
            }
        
            markers.forEach((marker) => {
                marker.setMap(null)
            })

            markers = []

            const bounds = new google.maps.LatLngBounds()
        
            places.forEach((place) => {
                if (!place.geometry || !place.geometry.location) {
                    return
                }
        
                const icon = {
                    url: place.icon,
                    size: new google.maps.Size(71, 71),
                    origin: new google.maps.Point(0, 0),
                    anchor: new google.maps.Point(17, 34),
                    scaledSize: new google.maps.Size(25, 25),
                }
        
                markers.push(new google.maps.Marker({map, icon, title: place.name, position: place.geometry.location}))
        
                if (place.geometry.viewport) {
                    bounds.union(place.geometry.viewport);
                } else {
                    bounds.extend(place.geometry.location);
                }
            })
            map.fitBounds(bounds);
        });

        google.maps.event.addListener(drawingManager, 'overlaycomplete', event => {
            if (event.type !== google.maps.drawing.OverlayType.MARKER) {
                deleteSelectedShape()
                drawingManager.setDrawingMode(null)

                let newShape = event.overlay

                newShape.type = event.type;
                newShape.id = new Date().getTime() + '_' + Math.floor(Math.random() * 1000)
                shapeCollection[newShape.id] = newShape
                
                google.maps.event.addListener(newShape, 'click', event => {
                    if (event.vertex) {
                        if (newShape.type === google.maps.drawing.OverlayType.POLYGON) {
                            let path = newShape.getPaths().getAt(event.path)

                            path.removeAt(event.vertex)
                            if (path.length < 3) newShape.setMap(null)
                        }
                        if (newShape.type === google.maps.drawing.OverlayType.POLYLINE) {
                            let path = newShape.getPath()

                            path.removeAt(event.vertex)
                            if (path.length < 2) newShape.setMap(null)
                        }
                    }
                    setSelection(newShape)
                })
                setSelection(newShape)
            }
        })

        google.maps.event.addListener(drawingManager, 'drawingmode_changed', clearSelection)
        google.maps.event.addListener(map, 'click', () => {clearSelection; infowindow.close()})
    }

</script>

<style>
    #map {
        height: 100%;
    }
    #pac-input {
        top: 10px !important;
    }
    html,
    body {
        height: 100%;
        margin: 0;
        padding: 0;
    }
</style>

  </body>
</html>
